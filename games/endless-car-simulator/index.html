<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless Car Simulator 3D - Neelakandan</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Inter', sans-serif;
        }

        canvas {
            display: block;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            z-index: 10;
        }

        #score {
            font-size: 24px;
            font-weight: bold;
        }

        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #game-over h1 {
            margin: 0 0 1rem 0;
            font-size: 2.5rem;
            color: #ff4757;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background: #1d4ed8;
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            text-decoration: none;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Mobile Controls */
        #mobile-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
            justify-content: space-between;
            padding: 0 40px;
            box-sizing: border-box;
            pointer-events: none;
            /* Let clicks pass through if not on buttons */
        }

        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            color: white;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            /* Re-enable clicks for buttons */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            /* KEY OPTIMIZATION: Disables browser zoom/scroll delay */
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            #mobile-controls {
                display: flex;
            }

            #instructions {
                display: none;
                /* Hide keyboard instructions on mobile */
            }
        }
    </style>
</head>

<body>

    <a href="../../index.html" class="back-btn">← Back to Home</a>

    <div id="ui">
        <div>Score: <span id="score">0</span></div>
    </div>

    <div id="game-over">
        <h1>GAME OVER</h1>
        <p>Your Score: <span id="final-score">0</span></p>
        <button onclick="resetGame()">Play Again</button>
    </div>

    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <div class="control-btn" id="btn-left">←</div>
        <div class="control-btn" id="btn-right">→</div>
    </div>

    <div id="instructions">Use LEFT / RIGHT arrows to steer</div>

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- GAME VARIABLES ---
        let scene, camera, renderer;
        let pCar, road, roadLines = [];
        let obstacles = [];
        let score = 0;
        let gameActive = true;
        let speed = 0.5;
        let roadWidth = 20; // Road width spans from -10 to 10
        let laneWidth = 6;
        let carPos = 0; // -1 (left), 0 (center), 1 (right)
        let targetX = 0;

        // Setup
        function init() {
            // Sceen
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e293b); // Slate background
            scene.fog = new THREE.Fog(0x1e293b, 20, 100);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, -5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // --- OBJECTS ---
            createRoad();
            createPlayerCar();

            // Loop
            animate();
        }

        function createRoad() {
            // Road Base
            const geometry = new THREE.PlaneGeometry(roadWidth, 400);
            const material = new THREE.MeshPhongMaterial({ color: 0x334155 }); // Road color
            road = new THREE.Mesh(geometry, material);
            road.rotation.x = -Math.PI / 2;
            road.position.z = -100;
            road.receiveShadow = true;
            scene.add(road);

            // Moving Lines
            for (let i = 0; i < 20; i++) {
                const lineGeo = new THREE.PlaneGeometry(0.5, 4);
                const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const line = new THREE.Mesh(lineGeo, lineMat);
                line.rotation.x = -Math.PI / 2;
                line.position.z = -i * 20;
                line.position.y = 0.02;
                // Add two lines for lanes
                const leftLine = line.clone();
                leftLine.position.x = -laneWidth / 2;

                const rightLine = line.clone();
                rightLine.position.x = laneWidth / 2;

                scene.add(leftLine);
                scene.add(rightLine);
                roadLines.push(leftLine, rightLine);
            }
        }

        function createPlayerCar() {
            const carGroup = new THREE.Group();

            // Body
            const bodyGeo = new THREE.BoxGeometry(2, 1, 4);
            const bodyMat = new THREE.MeshPhongMaterial({ color: 0xea580c }); // Orange
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.5;
            body.castShadow = true;
            carGroup.add(body);

            // Roof
            const roofGeo = new THREE.BoxGeometry(1.6, 0.8, 2);
            const roofMat = new THREE.MeshPhongMaterial({ color: 0xc2410c }); // Dark Orange
            const roof = new THREE.Mesh(roofGeo, roofMat);
            roof.position.y = 1.2;
            roof.position.z = -0.2;
            roof.castShadow = true;
            carGroup.add(roof);

            // Wheels
            const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.4, 16);
            const wheelMat = new THREE.MeshBasicMaterial({ color: 0x000000 });

            const w1 = new THREE.Mesh(wheelGeo, wheelMat);
            w1.rotation.z = Math.PI / 2;
            w1.position.set(1.1, 0.4, 1.2);
            carGroup.add(w1);

            const w2 = w1.clone(); w2.position.set(-1.1, 0.4, 1.2); carGroup.add(w2);
            const w3 = w1.clone(); w3.position.set(1.1, 0.4, -1.2); carGroup.add(w3);
            const w4 = w1.clone(); w4.position.set(-1.1, 0.4, -1.2); carGroup.add(w4);

            pCar = carGroup;
            scene.add(pCar);
        }

        function createObstacle() {
            // Spawn random obstacle
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshPhongMaterial({ color: 0xff3333 }); // Red box obstacle
            const obstacle = new THREE.Mesh(geometry, material);

            // Random Lane (-1, 0, 1)
            const lane = Math.floor(Math.random() * 3) - 1;
            obstacle.position.x = lane * laneWidth; // Spacing logic
            obstacle.position.y = 1;
            obstacle.position.z = -100; // Start far away
            obstacle.castShadow = true;

            scene.add(obstacle);
            obstacles.push(obstacle);
        }

        // --- CONTROLS ---
        function moveLeft() {
            if (!gameActive) return;
            if (carPos > -1) {
                carPos--;
                targetX = carPos * laneWidth;
            }
        }

        function moveRight() {
            if (!gameActive) return;
            if (carPos < 1) {
                carPos++;
                targetX = carPos * laneWidth;
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') moveLeft();
            if (e.key === 'ArrowRight') moveRight();
        });

        // Touch Controls (Optimized with Pointer Events)
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        function addTouchListener(elem, action) {
            // 'pointerdown' is faster than 'click' and 'touchstart' often has 300ms delay if not optimized
            elem.addEventListener('pointerdown', (e) => {
                e.preventDefault(); // Prevent accidental selection/scrolling
                action();
            });
        }

        addTouchListener(btnLeft, moveLeft);
        addTouchListener(btnRight, moveRight);

        function update() {
            if (!gameActive) return;

            // Score
            score += 1;
            document.getElementById('score').innerText = Math.floor(score / 10);

            // Speed increase
            speed = 0.5 + (score * 0.0001);

            // Car Movement (Lerp for smoothness)
            pCar.position.x += (targetX - pCar.position.x) * 0.1;
            // Car simple bounce/vibration
            pCar.position.y = 0.6 + Math.sin(Date.now() * 0.02) * 0.05;

            // Road Lines Animation
            roadLines.forEach(line => {
                line.position.z += speed;
                if (line.position.z > 10) {
                    line.position.z = -100;
                }
            });

            // Obstacles Logic
            if (Math.random() < 0.02) { // 2% chance per frame to spawn
                createObstacle();
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let ob = obstacles[i];
                ob.position.z += speed;

                // Collision Detection (Simple AABB-ish)
                if (ob.position.z > -3 && ob.position.z < 3) { // Near player Z
                    if (Math.abs(ob.position.x - pCar.position.x) < 2) { // Near player X
                        gameOver();
                    }
                }

                // Remove passed obstacles
                if (ob.position.z > 15) {
                    scene.remove(ob);
                    obstacles.splice(i, 1);
                }
            }
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('final-score').innerText = Math.floor(score / 10);
        }

        window.resetGame = function () {
            // Remove all obstacles
            obstacles.forEach(ob => scene.remove(ob));
            obstacles = [];
            score = 0;
            speed = 0.5;
            gameActive = true;
            document.getElementById('game-over').style.display = 'none';
        };

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>

</html>