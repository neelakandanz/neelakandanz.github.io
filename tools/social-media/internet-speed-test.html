<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Test - Social Tools | Neelakandan</title>
    <meta name="description" content="Check your internet connection speed, ping, and jitter instantly.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/global.css">
    <link rel="stylesheet" href="../../assets/css/components/header.css">
    <link rel="stylesheet" href="../../assets/css/components/tools.css">
    <style>
        .tool-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .panel {
            background: var(--color-surface);
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .gauge-container {
            position: relative;
            width: 300px;
            height: 150px;
            margin: 0 auto 2rem;
            overflow: hidden;
        }

        .gauge-bg {
            width: 300px;
            height: 150px;
            background: var(--color-surface-2);
            border-top-left-radius: 150px;
            border-top-right-radius: 150px;
        }

        .gauge-fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            transform-origin: center top;
            transform: rotate(0deg);
            transition: transform 0.3s ease-out;
        }

        .gauge-cover {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            height: 130px;
            background: var(--color-surface);
            border-top-left-radius: 130px;
            border-top-right-radius: 130px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .speed-text {
            text-align: center;
            margin-bottom: 2rem;
        }

        .primary-val {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1;
        }

        .unit {
            font-size: 1.2rem;
            color: var(--color-text-muted);
            margin-top: 5px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 600px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .metric-card {
            background: var(--color-surface-2);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
        }

        .metric-val {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .btn-go {
            background: var(--color-primary);
            color: white;
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            margin: 0 auto;
            display: block;
            box-shadow: 0 4px 15px rgba(var(--color-primary-rgb), 0.3);
            transition: all 0.2s;
        }

        .btn-go:hover {
            transform: scale(1.05);
        }

        .btn-go:disabled {
            background: var(--color-surface-2);
            color: var(--color-text-muted);
            cursor: not-allowed;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--color-surface-2);
            border-radius: 3px;
            margin-top: 1.5rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            width: 0%;
            transition: width 0.3s ease;
        }

        .server-info {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }
    </style>
</head>

<body>
    <header class="glass">
        <div class="container header-container">
            <a href="../../" class="logo">Neelakandan<span style="color:var(--color-accent)">.</span></a>
            <nav class="nav-menu">
                <ul>
                    <li><a href="../../">Home</a></li>
                    <li><a href="../#social-media">Tools</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="tools-page">
        <div class="container">
            <div class="tool-header">
                <a href="../#social-media" class="back-link">‚Üê Back to Social Tools</a>
                <h1>Internet Speed Test</h1>
                <p>Test your Ping, Jitter, Download, and Upload speed.</p>
            </div>

            <div class="tool-container">
                <div class="panel">

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Ping</div>
                            <div class="metric-val" id="ping">- ms</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Jitter</div>
                            <div class="metric-val" id="jitter">- ms</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Download</div>
                            <div class="metric-val" id="down">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Upload</div>
                            <div class="metric-val" id="up">--</div>
                        </div>
                    </div>

                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill" id="gauge-fill"></div>
                        <div class="gauge-cover"></div>
                    </div>

                    <div class="speed-text">
                        <div class="primary-val" id="main-val">0.00</div>
                        <div class="unit">Mbps</div>
                    </div>

                    <button class="btn-go" onclick="runTest()" id="btn-go">GO</button>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>

                    <div style="text-align:center; margin-top:1rem; color:var(--color-text-muted);" id="status-msg">
                        Click GO to start</div>

                    <div class="server-info" id="server-info">
                        Using Cloudflare Edge Network
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Test endpoints - Using Cloudflare's speed test endpoints
        const CLOUDFLARE_DOWN = 'https://speed.cloudflare.com/__down?bytes=';
        const CLOUDFLARE_UP = 'https://speed.cloudflare.com/__up';

        // Test file sizes for progressive testing
        const DOWNLOAD_SIZES = [
            100000,      // 100 KB - warmup
            1000000,     // 1 MB
            5000000,     // 5 MB
            10000000,    // 10 MB
            25000000,    // 25 MB
        ];

        const UPLOAD_SIZES = [
            100000,      // 100 KB - warmup
            500000,      // 500 KB
            1000000,     // 1 MB
            2000000,     // 2 MB
        ];

        let isRunning = false;

        async function measurePing() {
            const results = [];
            for (let i = 0; i < 10; i++) {
                const start = performance.now();
                try {
                    await fetch(CLOUDFLARE_DOWN + '0&r=' + Math.random(), {
                        cache: 'no-store',
                        mode: 'cors'
                    });
                    const end = performance.now();
                    results.push(end - start);
                } catch (e) {
                    console.error('Ping error:', e);
                }
                await sleep(50);
            }
            return results;
        }

        async function measureDownload(bytes) {
            const url = CLOUDFLARE_DOWN + bytes + '&r=' + Math.random();
            const start = performance.now();

            try {
                const response = await fetch(url, { cache: 'no-store', mode: 'cors' });
                const reader = response.body.getReader();
                let receivedBytes = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    receivedBytes += value.length;
                }

                const end = performance.now();
                const duration = (end - start) / 1000; // seconds
                const bitsReceived = receivedBytes * 8;
                const mbps = (bitsReceived / 1000000) / duration;

                return { mbps, duration, bytes: receivedBytes };
            } catch (e) {
                console.error('Download error:', e);
                return null;
            }
        }

        async function measureUpload(bytes) {
            const data = new Uint8Array(bytes);
            const start = performance.now();

            try {
                await fetch(CLOUDFLARE_UP + '?r=' + Math.random(), {
                    method: 'POST',
                    body: data,
                    mode: 'cors'
                });

                const end = performance.now();
                const duration = (end - start) / 1000;
                const bitsUploaded = bytes * 8;
                const mbps = (bitsUploaded / 1000000) / duration;

                return { mbps, duration, bytes };
            } catch (e) {
                console.error('Upload error:', e);
                return null;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateGauge(mbps) {
            let deg;
            if (mbps <= 0) {
                deg = 0;
            } else if (mbps >= 200) {
                deg = 180;
            } else {
                // Logarithmic scale for better visualization
                deg = (Math.log10(mbps + 1) / Math.log10(201)) * 180;
            }
            document.getElementById('gauge-fill').style.transform = `rotate(${deg}deg)`;
        }

        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        async function runTest() {
            if (isRunning) return;

            const btn = document.getElementById('btn-go');
            isRunning = true;
            btn.disabled = true;
            btn.textContent = "...";

            // Reset UI
            document.getElementById('ping').textContent = '- ms';
            document.getElementById('jitter').textContent = '- ms';
            document.getElementById('down').textContent = '--';
            document.getElementById('up').textContent = '--';
            document.getElementById('main-val').textContent = '0.00';
            updateProgress(0);
            updateGauge(0);

            const totalSteps = 2 + DOWNLOAD_SIZES.length + UPLOAD_SIZES.length;
            let currentStep = 0;

            try {
                // STEP 1: Measure Ping & Jitter
                document.getElementById('status-msg').textContent = 'Testing Latency...';
                const pings = await measurePing();
                currentStep++;
                updateProgress((currentStep / totalSteps) * 100);

                if (pings.length > 0) {
                    const minPing = Math.min(...pings);
                    const avgPing = pings.reduce((a, b) => a + b, 0) / pings.length;
                    const jitter = pings.reduce((a, b) => a + Math.abs(b - avgPing), 0) / pings.length;

                    document.getElementById('ping').textContent = Math.round(minPing) + ' ms';
                    document.getElementById('jitter').textContent = Math.round(jitter) + ' ms';
                }
                currentStep++;
                updateProgress((currentStep / totalSteps) * 100);

                // STEP 2: Measure Download Speed (progressive)
                document.getElementById('status-msg').textContent = 'Testing Download...';
                let downloadSpeeds = [];

                for (const size of DOWNLOAD_SIZES) {
                    const result = await measureDownload(size);
                    if (result && result.duration > 0.3) { // Only count if test ran long enough
                        downloadSpeeds.push(result.mbps);

                        // Update UI with current best estimate
                        const currentMbps = Math.max(...downloadSpeeds);
                        document.getElementById('down').textContent = currentMbps.toFixed(2) + ' Mbps';
                        document.getElementById('main-val').textContent = currentMbps.toFixed(2);
                        updateGauge(currentMbps);
                    }
                    currentStep++;
                    updateProgress((currentStep / totalSteps) * 100);

                    // If we have enough data, stop early for faster results
                    if (result && result.duration > 2) break;
                }

                // Calculate final download speed (median of valid results)
                if (downloadSpeeds.length > 0) {
                    downloadSpeeds.sort((a, b) => a - b);
                    const medianDown = downloadSpeeds[Math.floor(downloadSpeeds.length / 2)];
                    document.getElementById('down').textContent = medianDown.toFixed(2) + ' Mbps';
                    document.getElementById('main-val').textContent = medianDown.toFixed(2);
                    updateGauge(medianDown);
                }

                // STEP 3: Measure Upload Speed (progressive)
                document.getElementById('status-msg').textContent = 'Testing Upload...';
                let uploadSpeeds = [];

                for (const size of UPLOAD_SIZES) {
                    const result = await measureUpload(size);
                    if (result && result.duration > 0.3) {
                        uploadSpeeds.push(result.mbps);

                        const currentMbps = Math.max(...uploadSpeeds);
                        document.getElementById('up').textContent = currentMbps.toFixed(2) + ' Mbps';
                    }
                    currentStep++;
                    updateProgress((currentStep / totalSteps) * 100);

                    if (result && result.duration > 2) break;
                }

                // Calculate final upload speed
                if (uploadSpeeds.length > 0) {
                    uploadSpeeds.sort((a, b) => a - b);
                    const medianUp = uploadSpeeds[Math.floor(uploadSpeeds.length / 2)];
                    document.getElementById('up').textContent = medianUp.toFixed(2) + ' Mbps';
                }

                updateProgress(100);
                document.getElementById('status-msg').textContent = 'Test Complete';

            } catch (e) {
                console.error('Speed test error:', e);
                document.getElementById('status-msg').textContent = 'Error: ' + e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "GO";
                isRunning = false;
            }
        }
    </script>
</body>

</html>