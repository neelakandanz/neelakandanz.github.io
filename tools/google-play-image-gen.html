<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Play Asset Generator</title>
    <link rel="stylesheet" href="google-play-image-gen-style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® Google Play Asset Generator</h1>
            <p>Generate App Icon, Feature Graphic, and Screenshots to spec.</p>
        </div>
        
        <div class="content-wrapper">
            <a href="../index.html" class="btn btn-primary back-button">‚Üê Back to Tools</a>

            <div class="file-input-group">
                <h2 class="section-title">1. Upload Your Source Image</h2>
                <p>Upload a high-resolution image to be used as the source for all assets.</p>
                <input type="file" id="fileInput" accept="image/png, image/jpeg" onchange="handleImageUpload(event)">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üìÅ Select Image
                </button>
            </div>
            
            <div id="preview-container">
                <img id="source-image-preview" style="display: none;" alt="Source Image Preview">
            </div>

            <h2 class="section-title">2. Generated Assets</h2>
            <div id="output-section" class="output-grid" style="display: none;">
                
                <div class="output-card">
                    <h3>App Icon</h3>
                    <p>Required Size: 512px x 512px</p>
                    <canvas id="canvasIcon" width="512" height="512"></canvas>
                    <button class="btn btn-download" onclick="downloadCanvas('canvasIcon', 'app-icon', 'png')" disabled>
                        ‚¨áÔ∏è Download PNG
                    </button>
                </div>

                <div class="output-card">
                    <h3>Feature Graphic</h3>
                    <p>Required Size: 1024px x 500px</p>
                    <label for="scaleFeature" style="display: block; text-align: left; margin: 10px 0 5px; font-size: 0.9rem;">Scale: <span id="scaleValueFeature">100%</span></label>
                    <input type="range" id="scaleFeature" min="50" max="200" value="100" oninput="updateScale('Feature');" style="width: 100%; margin-bottom: 15px;">
                    <canvas id="canvasFeature" width="1024" height="500"></canvas>
                    <button class="btn btn-download" onclick="downloadCanvas('canvasFeature', 'feature-graphic', 'jpeg')" disabled>
                        ‚¨áÔ∏è Download JPG
                    </button>
                </div>

                <div class="output-card">
                    <h3>Screenshot (Landscape)</h3>
                    <p>Aspect Ratio: 16:9 (e.g., 1280px x 720px)</p>
                    <label for="scaleScreenshotL" style="display: block; text-align: left; margin: 10px 0 5px; font-size: 0.9rem;">Scale: <span id="scaleValueScreenshotL">100%</span></label>
                    <input type="range" id="scaleScreenshotL" min="50" max="200" value="100" oninput="updateScale('ScreenshotL');" style="width: 100%; margin-bottom: 15px;">
                    <canvas id="canvasScreenshotL" width="1280" height="720"></canvas>
                    <button class="btn btn-download" onclick="downloadCanvas('canvasScreenshotL', 'screenshot-landscape', 'jpeg')" disabled>
                        ‚¨áÔ∏è Download JPG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sourceImage = null;
        const outputSection = document.getElementById('output-section');
        const previewImage = document.getElementById('source-image-preview');
        const downloadButtons = document.querySelectorAll('.btn-download');

        // NEW STATE VARIABLES
        let scaleFeature = 1.0;
        let scaleScreenshotL = 1.0;
        // END NEW STATE VARIABLES

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    sourceImage = img;
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    outputSection.style.display = 'grid';
                    redrawAllCanvases();
                    downloadButtons.forEach(btn => btn.disabled = false);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        // NEW FUNCTION TO UPDATE SCALE
        function updateScale(assetType) {
            const slider = document.getElementById('scale' + assetType);
            const valueSpan = document.getElementById('scaleValue' + assetType);
            const newScale = parseInt(slider.value) / 100;

            if (assetType === 'Feature') {
                scaleFeature = newScale;
            } else if (assetType === 'ScreenshotL') {
                scaleScreenshotL = newScale;
            }

            valueSpan.textContent = slider.value + '%';
            redrawAllCanvases();
        }
        // END NEW FUNCTION

        function redrawAllCanvases() {
            if (!sourceImage) return;

            // 1. App Icon (512x512) - Uses 'cover' logic
            resizeAndDrawCover('canvasIcon', 512, 512, sourceImage);

            // 2. Feature Graphic (1024x500) - Uses 'scaled' logic
            resizeAndDrawScaled('canvasFeature', 1024, 500, sourceImage, scaleFeature);

            // 3. Phone Screenshot (16:9 Landscape - 1280x720) - Uses 'scaled' logic
            resizeAndDrawScaled('canvasScreenshotL', 1280, 720, sourceImage, scaleScreenshotL);
        }

        /**
         * Resizes and draws the source image onto a target canvas using a "cover" fit.
         * Used for App Icon where image must fill the entire canvas.
         */
        function resizeAndDrawCover(canvasId, targetWidth, targetHeight, img) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas and fill with white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, targetWidth, targetHeight);

            const imgRatio = img.width / img.height;
            const canvasRatio = targetWidth / targetHeight;

            let drawWidth, drawHeight, offsetX, offsetY;

            if (imgRatio > canvasRatio) {
                // Image is wider than canvas (in relation to height), scale by height
                drawHeight = targetHeight;
                drawWidth = drawHeight * imgRatio;
                offsetX = (targetWidth - drawWidth) / 2;
                offsetY = 0;
            } else {
                // Image is taller than canvas, scale by width
                drawWidth = targetWidth;
                drawHeight = drawWidth / imgRatio;
                offsetX = 0;
                offsetY = (targetHeight - drawHeight) / 2;
            }

            // Draw the image, covering the canvas
            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        }

        /**
         * Resizes and draws the source image onto a target canvas using a "contain" fit
         * then applies a user-defined scale factor for zoom.
         */
        function resizeAndDrawScaled(canvasId, targetWidth, targetHeight, img, scaleFactor) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas and fill with white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, targetWidth, targetHeight);

            // 1. Calculate max size for "contain" fit (base size)
            const imgRatio = img.width / img.height;
            
            let maxDrawWidth, maxDrawHeight;

            if (img.width / targetWidth > img.height / targetHeight) {
                // Image is constrained by canvas width
                maxDrawWidth = targetWidth;
                maxDrawHeight = targetWidth / imgRatio;
            } else {
                // Image is constrained by canvas height
                maxDrawHeight = targetHeight;
                maxDrawWidth = targetHeight * imgRatio;
            }
            
            // 2. Apply user scale factor
            const drawWidth = maxDrawWidth * scaleFactor;
            const drawHeight = maxDrawHeight * scaleFactor;

            // 3. Calculate centering offsets
            const offsetX = (targetWidth - drawWidth) / 2;
            const offsetY = (targetHeight - drawHeight) / 2;

            // 4. Draw the image
            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        }

        function downloadCanvas(canvasId, filename, format) {
            const canvas = document.getElementById(canvasId);
            let mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            let quality = format === 'jpeg' ? 0.9 : 1.0; // Set quality for JPG

            const link = document.createElement('a');
            link.download = `${filename}.${format}`;
            link.href = canvas.toDataURL(mimeType, quality);
            link.click();
        }

        window.onload = function() {
            // Initial call to ensure canvases are ready
            // The original logic here was in resizeAndDraw, which is now split.
            // The canvas attributes handle initial setup, but we keep this empty 
            // as it will only draw after an image upload.
        }
    </script>
</body>
</html>