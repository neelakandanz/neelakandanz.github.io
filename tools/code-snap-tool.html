<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Code Snap Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image-more/2.9.5/dom-to-image-more.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; }
        .back-button {
            position: fixed; top: 20px; left: 20px; background-color: #444; color: white;
            padding: 8px 16px; border-radius: 8px; text-decoration: none; z-index: 1000;
        }
        .back-button:hover { background-color: #555; }
        
        /* The Code Window Style */
        #code-window {
            font-family: 'Fira Code', monospace;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        #code-window pre {
            margin: 0;
            white-space: pre;
            /* Ensure the text doesn't overflow the rounded corners when padding is high */
            word-wrap: normal;
        }
        
        /* Custom scrollbar for better look in the preview */
        #code-window::-webkit-scrollbar { width: 8px; height: 8px; }
        #code-window::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 4px; }

        /* Mock window controls */
        .mock-controls { display: flex; align-items: center; margin-bottom: 12px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .dot:nth-child(1) { background-color: #ff5555; } /* Red */
        .dot:nth-child(2) { background-color: #f1fa8c; } /* Yellow */
        .dot:nth-child(3) { background-color: #50fa7b; } /* Green */
        
        /* Apply selected background color to the capture area */
        #capture-area {
            transition: background-color 0.3s ease;
            padding: 3rem; /* Default padding for the whole capture area */
        }

        /* Overrides to ensure highlight.js theme is applied */
        #code-window code {
            /* This ensures the code element uses the theme background and text color */
            display: block;
        }
        .hljs {
            background: transparent !important; /* Let the parent div handle the color */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/kotlin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>
</head>
<body class="p-8">
    <a href="../index.html#tools" class="back-button">← Back to Tools</a>

    <div class="container mx-auto max-w-7xl bg-gray-800 rounded-2xl shadow-2xl p-6 lg:p-10 flex flex-col lg:flex-row gap-8">
        
        <div class="flex-1 flex flex-col items-center justify-center min-h-[500px] bg-[#1a1a2e] rounded-xl">
            <h1 class="text-white text-3xl font-bold mb-6">Code Snap Generator</h1>
            <div id="capture-area" class="w-full max-w-xl flex justify-center items-center bg-[#1a1a2e] p-12">
                <div id="code-window" class="w-full rounded-xl overflow-hidden bg-[#282a36] text-sm shadow-xl max-h-[400px]">
                    <div class="p-4">
                        <div class="mock-controls">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                        <pre><code id="code-display" class="language-kotlin"></code></pre>
                    </div>
                </div>
            </div>
            <button id="download-btn" class="mt-8 px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors transform hover:scale-105">
                ⬇️ Export PNG
            </button>
        </div>

        <div class="lg:w-96 space-y-6 bg-gray-700 p-6 rounded-xl text-white">
            <h2 class="text-2xl font-semibold border-b border-gray-600 pb-3">Settings</h2>

            <div class="space-y-2">
                <label for="code-input" class="block text-sm font-medium text-gray-300">Paste Code</label>
                <textarea id="code-input" rows="8" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-900 text-white text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste your code here..."></textarea>
                <button id="render-btn" class="w-full px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                    Render Code
                </button>
            </div>
            
            <div class="space-y-4">
                <h3 class="text-xl font-medium border-b border-gray-600 pb-2">Appearance</h3>

                <div class="flex flex-col space-y-1">
                    <label for="language-select" class="text-sm font-medium text-gray-300">Language</label>
                    <select id="language-select" class="p-2 border border-gray-600 rounded-lg bg-gray-900 text-white">
                        <option value="kotlin">Kotlin</option>
                        <option value="dart">Dart</option>
                        <option value="javascript">JavaScript</option>
                        <option value="ruby">Ruby</option>
                        <option value="plaintext">Plain Text</option>
                    </select>
                </div>

                <div class="flex flex-col space-y-1">
                    <label for="theme-select" class="text-sm font-medium text-gray-300">Theme</label>
                    <select id="theme-select" class="p-2 border border-gray-600 rounded-lg bg-gray-900 text-white">
                        <option value="dracula">Dracula</option>
                        <option value="monokai">Monokai</option>
                        <option value="github-dark">GitHub Dark</option>
                        <option value="atom-one-light">Atom One Light</option>
                        <option value="a11y-dark">A11y Dark</option>
                    </select>
                </div>
                
                <div class="flex flex-col space-y-1">
                    <label for="font-size-slider" class="text-sm font-medium text-gray-300">Font Size: <span id="font-size-value">14</span>px</label>
                    <input type="range" id="font-size-slider" min="10" max="24" value="14" step="1" class="w-full">
                </div>

                <div class="flex flex-col space-y-1">
                    <label for="padding-slider" class="text-sm font-medium text-gray-300">Padding: <span id="padding-value">24</span>px</label>
                    <input type="range" id="padding-slider" min="12" max="64" value="24" step="4" class="w-full">
                </div>

                <div class="flex items-center justify-between space-x-2">
                    <label for="bg-color-picker" class="text-sm font-medium text-gray-300">Background Color</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="bg-color-picker" value="#1a1a2e" class="h-8 w-8 rounded-full cursor-pointer">
                        <button id="set-bg-btn" class="px-3 py-1 text-xs bg-gray-600 rounded hover:bg-gray-500">Apply</button>
                    </div>
                </div>

                <div class="flex items-center justify-between space-x-2 pt-2">
                    <label for="dark-mode-toggle" class="text-sm font-medium text-gray-300">Dark Mode (Theme)</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" checked class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-900 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const codeInput = document.getElementById('code-input');
        const codeDisplay = document.getElementById('code-display');
        const renderBtn = document.getElementById('render-btn');
        const downloadBtn = document.getElementById('download-btn');
        const captureArea = document.getElementById('capture-area');
        const codeWindow = document.getElementById('code-window');
        const languageSelect = document.getElementById('language-select');
        const themeSelect = document.getElementById('theme-select');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const paddingSlider = document.getElementById('padding-slider');
        const paddingValue = document.getElementById('padding-value');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const setBgBtn = document.getElementById('set-bg-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Element that wraps the code and needs padding control
        const codeContentWrapper = codeWindow.querySelector('#code-window > div');

        const initialCode = `class SegmentExample extends StatefulWidget {
    @override
    _SegmentExampleState createState() => _SegmentExampleState();
}

class _SegmentExampleState extends State<SegmentExample> {
    String selected = 'day';

    @override
    Widget build(BuildContext context) {
        return SegmentedButton<String>(
            segments: const [
                ButtonSegment(value: 'day', label: Text('Day')),
                ButtonSegment(value: 'night', label: Text('Night')),
            ],
            selected: {selected},
            onSelectionChanged: (newSelection) {
                setState(() => selected = newSelection.first);
            },
        );
    }
}`;

        // --- Core Functions ---

        // 1. Apply Syntax Highlighting
        function applyHighlighting() {
            const code = codeInput.value || '';
            const lang = languageSelect.value;
            
            codeDisplay.textContent = code;
            codeDisplay.className = 'language-' + lang;
            
            hljs.highlightElement(codeDisplay);
        }

        // 2. Apply Theme
        function applyTheme(theme) {
            const themeLink = document.querySelector('link[href*="highlight.js/"]');
            const newHref = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${theme}.min.css`;
            themeLink.href = newHref;

            // Update the window background color based on the theme style (approximate)
            let windowBg = '#282a36'; // Dracula default
            if (theme.includes('light')) {
                windowBg = '#ffffff';
            } else if (theme === 'monokai') {
                windowBg = '#272822';
            } else if (theme === 'github-dark' || theme === 'a11y-dark') {
                windowBg = '#0d1117';
            }
            codeWindow.style.backgroundColor = windowBg;
        }

        // 3. Apply Appearance Settings
        function applyAppearance() {
            // Font Size
            const fontSize = fontSizeSlider.value;
            fontSizeValue.textContent = fontSize;
            codeWindow.style.fontSize = `${fontSize}px`;

            // Padding (inner code block) - FIX APPLIED HERE
            const padding = paddingSlider.value;
            paddingValue.textContent = padding;
            
            // Apply the new padding to the inner content wrapper
            codeContentWrapper.style.padding = `${padding}px`;

            // Dark Mode Toggle (Controls overall capture background for contrast)
            if (darkModeToggle.checked) {
                // Ensure a dark background for the whole snap
                if (bgColorPicker.value.toLowerCase() === '#ffffff' || bgColorPicker.value.toLowerCase() === '#f5f5f5') {
                    bgColorPicker.value = '#1a1a2e';
                }
            } else {
                // Ensure a light background
                if (bgColorPicker.value.toLowerCase() === '#1a1a2e' || bgColorPicker.value.toLowerCase() === '#000000') {
                    bgColorPicker.value = '#ffffff';
                }
            }
            captureArea.style.backgroundColor = bgColorPicker.value;
        }

        // 4. Download Function
        function downloadImage() {
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'Processing...';
            downloadBtn.disabled = true;

            // Scale factor for high definition output
            const scale = 3;

            // DOM-to-Image settings
            const options = {
                width: captureArea.offsetWidth * scale,
                height: captureArea.offsetHeight * scale,
                style: {
                    transform: 'scale(' + scale + ')',
                    transformOrigin: 'top left'
                },
                // Exclude the fixed back button
                filter: (node) => {
                    return !(node.classList && node.classList.contains('back-button'));
                }
            };

            domtoimage.toPng(captureArea, options)
                .then(function (dataUrl) {
                    const link = document.createElement('a');
                    link.download = 'code-snap.png';
                    link.href = dataUrl;
                    link.click();
                })
                .catch(function (error) {
                    console.error('oops, something went wrong!', error);
                    alert('Could not save the image. Please try again.');
                })
                .finally(function() {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                });
        }


        // --- Event Listeners and Initialization ---
        
        // Initial setup
        codeInput.value = initialCode;
        languageSelect.value = 'dart';
        themeSelect.value = 'a11y-dark'; // Set to the theme shown in the screenshot
        bgColorPicker.value = '#282a36'; // Set initial capture area BG to the window BG for the A11y Dark theme
        codeWindow.style.backgroundColor = '#282a36'; // Initial Window BG
        darkModeToggle.checked = true;

        // Render & Download Buttons
        renderBtn.addEventListener('click', applyHighlighting);
        downloadBtn.addEventListener('click', downloadImage);

        // Appearance Controls
        languageSelect.addEventListener('change', applyHighlighting);
        themeSelect.addEventListener('change', (e) => {
            applyTheme(e.target.value);
            applyAppearance(); // Rerender appearance to check Dark Mode/BG Color logic
        });
        fontSizeSlider.addEventListener('input', applyAppearance);
        paddingSlider.addEventListener('input', applyAppearance);
        setBgBtn.addEventListener('click', applyAppearance);
        bgColorPicker.addEventListener('change', applyAppearance); // Added event listener for color change
        darkModeToggle.addEventListener('change', applyAppearance);


        // Initial run on load
        document.addEventListener('DOMContentLoaded', () => {
            applyAppearance();
            applyHighlighting();
        });
    </script>
</body>
</html>
